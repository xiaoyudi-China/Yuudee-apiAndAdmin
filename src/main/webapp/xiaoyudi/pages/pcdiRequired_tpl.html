<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Title</title>
    <script type="text/javascript" src="../js/rem.js"></script>
    <link rel="stylesheet" href="../css/currency.css">
    <link rel="stylesheet" href="../css/pcdiRequired.css">
    <script src="../js/jquery-1.11.2.min.js"></script>
    <script src="../js/jquery.tmpl.min.js"></script>
    <script type="text/javascript" src="../js/centent.js"></script>
    <script src="../js/api.js?v=20190404"></script>
    <style>
        .note {
            display: none;
            background: url("../img/assessment.png") no-repeat;
            width: 100%;
            position: fixed;
            top: 0;
            bottom: 0;
            padding-top: .85rem;
            box-sizing: border-box;
            z-index: 10;
        }
        .note .title-content{
            position: relative;
        }
        .note .left_button {
            position: absolute;
            left: .35rem;
            top: 50%;
            height: .865rem;
            /*width: .78rem;*/
            cursor: pointer;
            transform: translate(0, -50%);
        }

        .note .title {
            font-family: STYuanti-SC-Bold;
            font-size: .44rem;
            color: #a36033;
            margin: 0 auto .9rem auto;
            text-align: center;
        }

        .note .text {
            margin: 0 .5rem;
            color: #14101e;
            text-indent: .88rem;
            font-size: .28rem;
            line-height: .56rem;
        }
    </style>
</head>

<body>
<div id="noteContent" class="note">
    <div class="title-content">
        <img id="backQuestion" src="../img/left_button.png" class="left_button" alt="">
        <p class="title">语言评估答题说明</p>
    </div>
    <p class="text">这是一份了解幼儿汉语言词汇和沟通能力的量 表。如果您的孩子还不会说该词或者只是重复别人，请填“不会说”（选择第一个圆圈）；如果您的孩子会说该词而不是马上重复别人说过的词，请填“会说”（可选择第二个圆圈）。假如您的孩子对该词的发音不准（例如：火车说成“火些”）或他的说法有所不同（例一：葡萄说成“萄”；例二：老鼠说成“耗子”），仍算做会说。当遇到“面/面条”这种中间划有“/”的词汇时，对会说“/”两侧中的一个词即为“会说”。这个词表是用于不同年龄的孩子，完全有可能您的孩子现在只知道这个词表中较少的词，甚至根本不知道，也属于正常范围，请不要为孩子究竟知道其中多少个字词而担心。</p>
</div>
<div class="header">
    <p class="title">语言评估必填问卷</p>
    <p class="msg">汉语沟通发展量表：词汇及句子</p>
    <img src="../img/home_button.png" class="home_button" alt="">
</div>
<div class="centent">
    <div class="top clearfix">
        <span class="l">必做部分</span>
        <p id="note" class="r"><span>查看答题说明<img class="r" src="../img/button_right.png" alt=""></span></p>
    </div>
    <div id="topicList">
        <!--<div class="title">-->
        <!--C-小孩组合字-->
        <!--<div class="dashed"></div>-->
        <!--</div>-->
        <!--<p class="notes">-->
        <!--注：“有时”即指孩子用过一次以上；“经常”即指需-->
        <!--要用到时候大部分会用到。-->
        <!--</p>-->
        <!--<ul>-->
        <!--<li>-->
        <!--<div class="black_spot"></div>-->
        <!--<p class="subject">您的孩子有没有开始把几个字组合在一起？(例：“妈妈车”.“地饼干”)</p>-->
        <!--<div class="clearfix radio">-->
        <!--<p class="l"><img src="../img/no_select.png" alt="">还没有</p>-->
        <!--<p class="l selectColor"><img src="../img/select.png" alt="">有时会</p>-->
        <!--<p class="l"><img src="../img/no_select.png" alt="">经常会</p>-->
        <!--</div>-->
        <!--<p class="subject" style="margin-bottom: 0;">请列出您孩子最近说过的三个最长的句子</p>-->
        <!--<div class="input_box" style="margin-top: .24rem"><input type="text" placeholder="请输入句子1"></div>-->
        <!--<div class="input_box"><input type="text" placeholder="请输入句子2"></div>-->
        <!--<div class="input_box"><input type="text" placeholder="请输入句子3"></div>-->
        <!--</li>-->
        <!--</ul>-->
    </div>
    <!--<div class="title" style="margin-bottom: .26rem">-->
    <!--D-复杂性-->
    <!--<div class="dashed"></div>-->
    <!--</div>-->

</div>
<div class="Submission" id="determine">
    确定
</div>
<div class="mask"></div>
<div class="dialog">
    <!--<img src="../img/close.png" alt="">-->
    <p class="Htitle">您已经完成了语言评估必做部分问卷</p>
    <p class="msg1">
        如您愿意全部完成必做和选做部分，将可以获得幼童汉语言发展水平的完整评估。仅完成必做部分不会影响新雨滴训练的使用，但将无法获取完整评估打分。
        接下来的选做部分将花费您10-15分钟时间。
    </p>
    <div class="button clearfix">
        <div class="Submission l l1">
            确定提交
        </div>
        <div class="Submission l l2">
            继续评估
        </div>
    </div>
</div>
<div class="dialog1">
    <!--<img src="../img/close.png" alt="">-->
    <p class="msg1">
        您尚未填写完问卷评估，如果您现在退出，
        我们将会为您已经填写的部分保留1周时间，如
        果超过1周需要重新填写，因为孩子可能已经发
        生了很大的进步！您确定退出吗？
    </p>
    <div class="button clearfix">
        <div class="Submission l l3">
            继续填写
        </div>
        <div class="Submission l l4">
            确定退出
        </div>
    </div>
</div>
<div class="dialog2">
    <!--<img src="../img/close.png" alt="">-->
    <p class="msg1" style="margin-bottom: 1.58rem;">
        您尚未填写完问卷评估，无法提交。
    </p>
    <div class="button clearfix">
        <div class="Submission l l6">
            取消
        </div>
        <div class="Submission l l6">
            确定
        </div>
    </div>
</div>


<script type="text/x-jquery-tmpl" id="list">
    <div style="position:relative">
        <div class="title">
            ${pcidType.name}
            <div class="dashed"></div>
        </div>
    </div>
    {{if pcidType.title != ''}}
    <p class="notes" >
       ${pcidType.title}
    </p>
    {{/if}}
    <ul>
    {{each(i,item) pcidList}}
        <li>
            <div class="black_spot"></div>
            <p class="subject">${i+1}. ${item.topicTitle}</p>
            <div class="clearfix radio">
            <!--<p class="l selectColor"><img src="../img/select.png" alt="">${o}</p>-->
                {{each(ind,o) item.topicResultOne}}
                    {{if pcidType.nameEnum == 5}}
                        {{if item.topicResultOne.length <= 3}}
                            <p class="l ${ind == (item.answerid - 1) && o == item.answer ? 'selectColor' : ''}" style="margin-right:.2rem;" citype="${item.type}" cihui="${pcidType.nameEnum == 5 ? true : false}" jifen="${item.isScore == '1' ? true : false}" juzi="${pcidType.nameEnum == 4 ? true : false}" data-isother="${item.isOtherOptions}" data-sign="${item.sign}" data-id="${pcidType.id}|${item.id}" data-pcdiTypeId="${item.pcdiTypeId}" data-input="${item.childOptions != null ? item.childOptions : null}" data-val="${o}"><img src="${ind ==  (item.answerid - 1) && o == item.answer ? '../img/select.png' : '../img/no_select.png'}" alt="">${o}</p>
                        {{else}}
                            <p class="l ${ind == (item.answerid - 1) && o == item.answer ? 'selectColor' : ''}" citype="${item.type}" cihui="${pcidType.nameEnum == 5 ? true : false}" jifen="${item.isScore == '1' ? true : false}" juzi="${pcidType.nameEnum == 4 ? true : false}" style="margin-right:.1rem;" data-isother="${item.isOtherOptions}" data-sign="${item.sign}" data-id="${pcidType.id}|${item.id}" data-pcdiTypeId="${item.pcdiTypeId}" data-input="${item.childOptions != null ? item.childOptions : null}" data-val="${o}"><img src="${ind ==  (item.answerid - 1) && o == item.answer ? '../img/select.png' : '../img/no_select.png'}" alt="">${o}</p>
                        {{/if}}
                    {{else}}
                        {{if item.topicResultOne.length <= 3}}
                            <p class="l ${ind == item.answerid && o == item.answer ? 'selectColor' : ''}" style="margin-right:.2rem;" citype="${item.type}" cihui="${pcidType.nameEnum == 5 ? true : false}" jifen="${item.isScore == '1' ? true : false}" juzi="${pcidType.nameEnum == 4 ? true : false}" data-isother="${item.isOtherOptions}" data-id="${pcidType.id}|${item.id}" data-pcdiTypeId="${item.pcdiTypeId}" data-input="${item.childOptions != null ? item.childOptions : null}" data-val="${o}"><img src="${ind == item.answerid && o == item.answer ? '../img/select.png' : '../img/no_select.png'}" alt="">${o}</p>
                        {{else}}
                            <p class="l ${ind == item.answerid && o == item.answer ? 'selectColor' : ''}" citype="${item.type}" cihui="${pcidType.nameEnum == 5 ? true : false}" jifen="${item.isScore == '1' ? true : false}" juzi="${pcidType.nameEnum == 4 ? true : false}" style="margin-right:.1rem;" data-isother="${item.isOtherOptions}" data-id="${pcidType.id}|${item.id}" data-pcdiTypeId="${item.pcdiTypeId}" data-input="${item.childOptions != null ? item.childOptions : null}" data-val="${o}"><img src="${ind == item.answerid && o == item.answer ? '../img/select.png' : '../img/no_select.png'}" alt="">${o}</p>
                        {{/if}}
                    {{/if}}
                {{/each}}

            </div>
            {{if item.childOptions != null && pcidType.nameEnum == 3}}
                <div style="display:none;" class="input_child">
                    <p class="subject" style="margin-bottom: 0;">请列出您孩子最近说过的三个最长的句子</p>
                    <div class="input_box" style="margin-top: .24rem"><input id="firstSentence" data-id="${pcidType.id}|${item.id}" type="text" placeholder="请输入句子1"></div>
                    <div class="input_box"><input id="secondSentence" data-id="${pcidType.id}|${item.id}" type="text" placeholder="请输入句子2"></div>
                    <div class="input_box"><input id="thirdSentence" data-id="${pcidType.id}|${item.id}" type="text" placeholder="请输入句子3"></div>
                </div>
            {{/if}}
        </li>
    {{/each}}
    </ul>


</script>
<script>
    var timer;
    var disabled = false
    var move = function (obj, y, t, options) {
        options = options || {}
        options.type = options.type || 'buffer'
        options.time = options.time || 100
        let count = parseInt(options.time / 30)
        let n = 0
        let a
        let cur
        clearInterval(timer)
        timer = setInterval(function () {
            n++
            switch (options.type) {
                case 'linear':        // 匀速
                    // var cur=y*n/count;
                    a = n / count
                    if (t < y) {
                        cur = t + (y - t) * a
                    } else {
                        cur = t - (t - y) * a
                    }
                    break
                case 'buffer':        // 缓冲
                    a = 1 - n / count;
                    if (t < y) {
                        cur = t + (y - t) * (1 - a * a * a)
                    } else {
                        cur = t - (t - y) * (1 - a * a * a)
                    }
                    break
                case 'ease-in':        // 加速
                    a = n / count
                    cur = y * (a * a * a)
                    break
            }
            window.parent.window.scrollTo(0, cur)
            if (n === count) {
                clearInterval(timer)
                options.end && options.end()
            }
        }, 30)
    }
    $(function () {
        // window.vConsole = new window.VConsole({
        //     defaultPlugins: ['system', 'network', 'element', 'storage'], // 可以在此设定要默认加载的面板
        //     maxLogNumber: 1000,
        //     // disableLogScrolling: true,
        //     onReady: function() {
        //         console.log('vConsole is ready.');
        //     },
        //     onClearLog: function() {
        //         console.log('on clearLog');
        //     }
        // });
        // 清楚缓存
        localStorage.removeItem('data')
        localStorage.removeItem('firstSentence')
        localStorage.removeItem('secondSentence')
        localStorage.removeItem('thirdSentence')
        var y = 0
        $('#topicList').on('focus', 'input', function () {
            y = $('.centent').scrollTop()
        })
        $('#topicList').on('blur', 'input', function () {
            let t = $('.centent').scrollTop()
            clearInterval(timer)
            move(this, y, t)
        })

        function getUrlParam(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
            var r = window.location.search.substr(1).match(reg);  //匹配目标参数
            if (r != null) return unescape(r[2]);
            return null; //返回参数值
        }

        var resultId;
        var status
        var count
        var id = getUrlParam('id');
        var answerJSON = {};
        var answerList = [];
        var totalNumber = 0;
        toAssess().then(
            function (res) {
                if (res.code == 200) {
                    status = Number(res.data.pcdiState)
                    count = Number(res.data.pcdiCount)
                    getMust()
                }
            },
            function (err) {
                console.log(err)
            }
        )
        $('.home_button').click(function () {
            $('.mask').show();
            $('.dialog1').show()
        })
        $('.l3').click(function () {
            $('.mask').hide();
            $('.dialog1').hide()
        })
        //确定中途退出
        $('.l4').click(function () {
            cache(function () {
                toAssess({pcdiState:1}).then(
                    function (res) {
                        if (res.code == 200) {
                            if (window.webkit) {
                                window.webkit.messageHandlers.goBack.postMessage(null);
                            } else {
                                android.goBack();
                            }
                        } else {
                            tips(res.msg);
                        }
                    },
                    function (err) {
                        console.log(err)
                    }
                )
            })
        })
        $('.l6').click(function () {
            $('.mask').hide();
            $('.dialog2').hide()
        })

        $('.l1').click(function () {
            if (disabled) return false
            disabled = true
            var data = getAnswer();
            data.resultList = JSON.stringify(data.resultList)
            post('/addPcdiResult', data).then(
                function (res) {
                    if (res.code == 200) {
                        toAssess({pcdiCount: count+=1, pcdiState:2}).then(
                            function (res) {
                                if (res.code == 200) {
                                    window.location.href = 'requiredPresentation.html'
                                } else {
                                    tips(res.msg);
                                }
                            },
                            function (err) {
                                console.log(err)
                            }
                        )

                    } else {
                        tips(res.msg);
                    }
                    disabled = false
                },
                function (err) {
                    console.log(err)
                }
            )
        })
        $('.l2').click(function () {
            var data = getAnswer();
            data.resultList = JSON.stringify(data.resultList)
            localStorage.setItem('datas', JSON.stringify(data))
            window.location.href = 'pcdiNonCompulsory.html?id=' + resultId + '&pcdiNonId=' + id
        })

        //回显渲染
        function echo(data, json, state) {
            var showInputChild = false
            var inputArr = []
            if (data.data) {
                data.data.forEach(function (items) {
                    items.answerid = state == 'new' ? items.sign : items.answerid
                    json[items.topicType].pcidList.forEach(function (item) {
                        if (JSON.stringify(item.id) == items.topicId) {
                            if (state == 'new') {
                                item.answerid = items.sign
                                item.subAnswer = [items.answerOne, items.answerTwo, items.answerThree]
                            } else {
                                item.answerid = items.answerid
                                item.subAnswer = items.subAnswer
                            }
                            item.answer = items.answer

                            if (item.isScore == '1') {
                                items.jifen = 'true'
                            }
                            items.type = parseInt(item.type)

                        }
                    });
                    if (json[items.topicType].pcidType.nameEnum == 3 && json[items.topicType].pcidList[0].answerid != 0) {
                        if (state == 'new') {
                            inputArr = [items['answerOne'], items['answerTwo'], items['answerThree']]
                        } else if(items.subAnswer.length !== 0){
                            inputArr = [items.subAnswer[0], items.subAnswer[1], items.subAnswer[2]]
                        }
                        showInputChild= true
                    }
                    if (json[items.topicType].pcidType.nameEnum == 4) {
                        items.juzi = true
                    }
                    if (json[items.topicType].pcidType.nameEnum == 5) {
                        items.cihui = true
                    }
                    items.subAnswer = state == 'new' ? [items.answerOne, items.answerTwo, items.answerThree] : items.subAnswer
                    answerJSON[items.topicType + '|' + items.topicId] = items;
                });
            }
            var n = [];
            for (var key in json) {
                n.push(json[key])
            }
            $('#topicList').empty();
            $('#list').tmpl(n).appendTo('#topicList')
            if (showInputChild) {
                $('#firstSentence').val(inputArr[0])
                $('#secondSentence').val(inputArr[1])
                $('#thirdSentence').val(inputArr[2])
                $('.input_child').show()
            }
        }

        function getCache(json) {
            //    获取缓存7天的数据
            get('/getCache', {type: 1}).then(
                function (data) {
                    if (data.code == 200) {
                        echo(data, json, 'old')
                    } else {
                        tips(data.msg);
                    }

                },
                function (err) {
                    console.log(err)
                }
            )
        }

        function mustAndResult(json) {
            //重新评估获取上次提交的数据
            get('/getPcdi/mustAndResult', {answerId: id}).then(
                function (data) {
                    if (data.code == 200) {
                        echo(data, json, 'new')
                    } else {
                        tips(data.msg);
                    }

                },
                function (err) {
                    console.log(err)
                }
            )
        }

        //获取题
        function getMust () {
            get('/getPcdi/must').then(
                function (res) {
                    if (res.code == 200) {
                        var json = {};
                        res.data.forEach(function (items) {
                            totalNumber = totalNumber += items.pcidList.length;
                            items.pcidList.forEach(function (item) {
                                item.topicResultOne = item.topicResultOne.split('|')
                            })
                            json[items.pcidType.id] = items;
                        })
                        if (status === 0) {
                            $('#topicList').empty();
                            $('#list').tmpl(res.data).appendTo('#topicList')
                        } else if (status === 1){
                            getCache(json);
                        } else {
                            mustAndResult(json);
                        }
                    } else {
                        tips(res.msg);
                    }

                },
                function (err) {
                    console.log(err)
                }
            )
        }
        //做题
        $('#topicList').delegate('.radio p', 'click', function () {
            var childInd = $(this).data('input');
            var id = $(this).data('id');
            var isOtherOptions = $(this).data('isother');
            var pcdiTypeId = $(this).data('pcditypeid');
            var ind = $(this).index();
            var sign = $(this).data('sign')
            var val = $(this).data('val');
            var juzi = $(this).attr('juzi');
            var jifen = $(this).attr('jifen');
            var citype = $(this).attr('citype');
            var cihui = $(this).attr('cihui');
            var radio = $(this).parents('.radio');
            radio.find('p').removeClass('selectColor');
            radio.find('img').attr('src', '../img/no_select.png');
            $(this).addClass('selectColor');
            $(this).find('img').attr('src', '../img/select.png')
            var childOptions = $(this).parents('li').find('.input_child');
            if (childInd != '') {
                if (JSON.stringify(childInd).indexOf(JSON.stringify(ind + 1)) != -1) {
                    childOptions.show();
                } else {
                    childOptions.hide();
                }
            }
            ;
            answerJSON[id] = {
                topicId: id.split('|')[1],
                topicType: pcdiTypeId,
                answer: val,
                answerid: ind,
                isOtherOptions: typeof (isOtherOptions) != 'string' ? JSON.stringify(isOtherOptions) : isOtherOptions,
                subAnswer: []
            };

            if (juzi == 'true') {
                answerJSON[id].juzi = true
                answerJSON[id].jifen = jifen
            } else if (cihui == 'true') {
                answerJSON[id].cihui = true
                answerJSON[id].type = citype
                // 词汇掌握前测
                // 会做一分，不会做0分，但是只有一分的时候计分，又因为sign需要对应下标（1，2）所以，把0分改成2分 --modify by lupe 2019-03-28
                var cihuianswerid = [1, 2]
                answerJSON[id].answerid = cihuianswerid[ind]
            }
            // console.log(answerJSON)
        });

        //获取已做题的数据
        function getAnswer() {
            $('ul input').each(function (i, item) {
                var id = $(item).data('id');
                if (answerJSON[id] && $(item).val() != '') {
                    answerJSON[id].subAnswer[i] = $(item).val()
                }
            });
            var nounCount = 0;
            var verbCount = 0;
            var adjCount = 0;
            var score = 0;
            var answerJSON1 = JSON.parse(JSON.stringify(answerJSON));
            for (var key in answerJSON1) {
                var obj = answerJSON1[key]
                for (var i = 0; i < 3; i++) {
                    if (!obj.subAnswer[i]) {
                        obj.subAnswer[i] = ''
                    }
                }
                // console.log(obj)
                if (obj.juzi == true && obj.jifen == 'true') {
                    score = score + parseInt(obj.answerid)
                } else if (obj.cihui == true && obj.answerid == 1) {
                    if (obj.type == '1') {
                        nounCount = nounCount += 1
                    } else if (obj.type == '2') {
                        verbCount = verbCount += 1
                    } else {
                        adjCount = adjCount += 1
                    }
                }
                delete obj.juzi
                delete obj.jifen
                delete obj.type
                delete obj.cihui
                obj.answer = obj.answer.toString()
                if (obj.sign) obj.sign = '' + obj.sign
                // console.log(obj)
                var flag = false
                for (var i = 0; i < answerList.length; i++) {
                    if (key.split('|')[0] == answerList[i].topicType && key.split('|')[1] == answerList[i].topicId) {
                        answerList[i] = obj
                        flag = true
                    }
                }
                if (!flag)  answerList.push(obj)
            }
            var params = {
                nounCount: nounCount,
                verbCount: verbCount,
                adjCount: adjCount,
                score: score,
                pcdiCache: false,
                resultList: answerList

            }
            return params
        }

        //提交
        $('#determine').click(function () {
            var data = getAnswer();
            if (data.resultList.length < totalNumber) {
                tips('您尚未填写完问卷评估，无法提交。');
                var isHasFindNoSelector = false
                $('#topicList').find('li').each(function (index, item) {
                    if (!isHasFindNoSelector && $(item).find('.selectColor').length === 0) {
                        $('.centent').scrollTop($(item).position().top - $(item).parent().parent().position().top)
                        isHasFindNoSelector = true
                        $(window).scroll($(item).offset().top);

                    }
                })
                // 没答完题，清空会导致分数不累加 modify by lupe 2019-03-28
                // answerJSON = {};
                return
            } else {
                cache(function () {
                    $('.mask').show();
                    $('.dialog').show()
                })
            }
        });
        // 缓存
        function cache (callback) {
            var data = getAnswer();
            data.resultList = JSON.stringify(data.resultList)
            delete data.nounCount
            delete data.verbCount
            delete data.adjCount
            delete data.score
            data.pcdiCache = true
            post('/addPcdiResult', data).then(
                function (res) {
                    // res.code = 209token过期
                    if (res.code == 200 || res.code == 209 || res.code == 203) {
                        callback()
                    } else {
                        tips(res.msg);
                    }
                },
                function (err) {
                    console.log(err)
                }
            )
        }

        // 查看答题说明
        $('#note').on('click', function () {
            $('#noteContent').show()
        })

        // 从答题说明返回
        $('#backQuestion').on('click', function () {
            $('#noteContent').hide()
        })
    });
</script>
</body>
</html>
